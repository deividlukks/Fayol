import { config, validateConfig } from './config/app.config';
import { logger } from './utils/logger';
import { BaileysProvider } from './providers/baileys/baileys.provider';
import { TwilioProvider } from './providers/twilio/twilio.provider';
import { ProviderFactory } from './providers/factory/provider.factory';
import { WebhookServer } from './services/webhook-server.service';
import { CronJobs } from './cron/daily-summary.cron';
import { SessionManager } from './middleware/session.middleware';

/**
 * Fayol WhatsApp Bot - H√≠brido
 * 
 * Arquitetura:
 * - Baileys: Usu√°rios FREE (gratuito)
 * - Twilio: Usu√°rios PREMIUM (pago)
 * 
 * @version 1.0.0
 */
class FayolWhatsAppBot {
  private webhookServer: WebhookServer | null = null;

  /**
   * Inicializa o bot
   */
  async start(): Promise<void> {
    try {
      logger.info('üöÄ Iniciando Fayol WhatsApp Bot...');

      // Valida configura√ß√µes
      validateConfig();

      // Inicia servidor de webhooks (se Twilio habilitado)
      if (config.twilio.enabled) {
        logger.info('üåê Iniciando servidor de webhooks Twilio...');
        this.webhookServer = new WebhookServer();
        this.webhookServer.start();
      }

      // Inicia cron jobs
      logger.info('‚è∞ Iniciando cron jobs...');
      CronJobs.start();

      // Se Baileys habilitado, pode iniciar providers pr√©-configurados aqui
      // Por enquanto, providers s√£o criados sob demanda via Factory

      logger.info('‚úÖ Fayol WhatsApp Bot iniciado com sucesso!');
      logger.info('');
      logger.info('üìä Status dos Providers:');
      logger.info(`   - Baileys: ${config.baileys.enabled ? '‚úÖ Habilitado' : '‚ùå Desabilitado'}`);
      logger.info(`   - Twilio: ${config.twilio.enabled ? '‚úÖ Habilitado' : '‚ùå Desabilitado'}`);
      logger.info('');

      if (config.baileys.enabled) {
        logger.info('‚ÑπÔ∏è  Usu√°rios FREE usar√£o Baileys (gratuito)');
        logger.info('   Para conectar, escaneie o QR Code que aparece no terminal');
      }

      if (config.twilio.enabled) {
        logger.info('‚ÑπÔ∏è  Usu√°rios PREMIUM usar√£o Twilio (pago)');
        logger.info(`   Webhook: ${config.twilio.webhookUrl}`);
      }

      logger.info('');
      logger.info('üéØ Bot pronto para receber mensagens!');

      // Graceful shutdown
      this.setupGracefulShutdown();

    } catch (error) {
      logger.error('‚ùå Erro ao iniciar bot:', error);
      process.exit(1);
    }
  }

  /**
   * Configura encerramento gracioso
   */
  private setupGracefulShutdown(): void {
    const shutdown = async (signal: string) => {
      logger.info(`\nüì¥ Recebido sinal ${signal}. Encerrando graciosamente...`);

      try {
        // Para cron jobs
        CronJobs.stop();

        // Desconecta todos os providers
        await ProviderFactory.clearAll();

        // Limpa sess√µes
        logger.info('[Shutdown] Salvando sess√µes...');
        // SessionManager.saveToFile(); // Implementar se necess√°rio

        logger.info('‚úÖ Encerramento conclu√≠do');
        process.exit(0);
      } catch (error) {
        logger.error('‚ùå Erro durante encerramento:', error);
        process.exit(1);
      }
    };

    // Captura sinais de encerramento
    process.on('SIGINT', () => shutdown('SIGINT'));
    process.on('SIGTERM', () => shutdown('SIGTERM'));

    // Captura exce√ß√µes n√£o tratadas
    process.on('uncaughtException', (error) => {
      logger.error('‚ùå Exce√ß√£o n√£o tratada:', error);
      shutdown('uncaughtException');
    });

    process.on('unhandledRejection', (reason, promise) => {
      logger.error('‚ùå Promise rejeitada n√£o tratada:', reason);
      shutdown('unhandledRejection');
    });
  }

  /**
   * Para o bot
   */
  async stop(): Promise<void> {
    logger.info('üõë Parando Fayol WhatsApp Bot...');

    // Para cron jobs
    CronJobs.stop();

    // Desconecta providers
    await ProviderFactory.clearAll();

    logger.info('‚úÖ Bot parado com sucesso');
  }
}

// ===============================================
// PONTO DE ENTRADA
// ===============================================

const bot = new FayolWhatsAppBot();

bot.start().catch((error) => {
  logger.error('‚ùå Erro fatal ao iniciar bot:', error);
  process.exit(1);
});

// Exporta para uso em testes
export default bot;
